//Main
package exercicio007;

public class Exercicio007 {

    public static void main(String[] args) {
        Biblioteca biblioteca = new Biblioteca();

        Autor autor1 = new Autor("J.K. Rowling");
        Autor autor2 = new Autor("George Orwell");

        Livro livro1 = new Livro("Harry Potter", autor1);
        Livro livro2 = new Livro("1984", autor2);

        biblioteca.adicionarLivro(livro1);
        biblioteca.adicionarLivro(livro2);

        Usuario usuario1 = new Usuario("João");
        Usuario usuario2 = new Usuario("Maria");

        biblioteca.adicionarUsuario(usuario1);
        biblioteca.adicionarUsuario(usuario2);

        biblioteca.emprestarLivro(livro1, usuario1);
        biblioteca.emprestarLivro(livro2, usuario2);

        biblioteca.listarLivrosMaisPopulares();

        biblioteca.devolverLivro(livro1, usuario1);
    }    
}
//CLASSE AUTOR
package exercicio007;

public class Autor {
    private String nome;

    public Autor() {}

    public Autor(String nome) {
        this.nome = nome;
    }

    public String getNome() {
        return nome;
    }

    public void setNome(String nome) {
        this.nome = nome;
    }
}

//CLASSE LIVRO
package exercicio007;

public class Livro {
    
    private String titulo;
    private Autor autor;
    private boolean disponivel;
    private int vezesEmprestado;

    public Livro() {
        this.disponivel = true;
        this.vezesEmprestado = 0;
    }

    public Livro(String titulo, Autor autor) {
        this.titulo = titulo;
        this.autor = autor;
        this.disponivel = true;
        this.vezesEmprestado = 0;
    }

    public String getTitulo() {
        return titulo;
    }

    public void setTitulo(String titulo) {
        this.titulo = titulo;
    }

    public Autor getAutor() {
        return autor;
    }

    public void setAutor(Autor autor) {
        this.autor = autor;
    }

    public boolean isDisponivel() {
        return disponivel;
    }

    public void setDisponivel(boolean disponivel) {
        this.disponivel = disponivel;
    }

    public int getVezesEmprestado() {
        return vezesEmprestado;
    }

    public void incrementarEmprestimo() {
        this.vezesEmprestado++;
    }
}

//CLASSE USUARIO
package exercicio007;

import java.util.ArrayList;
import java.util.List;

public class Usuario {
    
    private String nome;
    private List<Livro> livrosEmprestados;

    public Usuario() {
        this.livrosEmprestados = new ArrayList<>();
    }

    public Usuario(String nome) {
        this.nome = nome;
        this.livrosEmprestados = new ArrayList<>();
    }

    public String getNome() {
        return nome;
    }

    public void setNome(String nome) {
        this.nome = nome;
    }

    public List<Livro> getLivrosEmprestados() {
        return livrosEmprestados;
    }

    public void emprestarLivro(Livro livro) {
        livrosEmprestados.add(livro);
    }

    public void devolverLivro(Livro livro) {
        livrosEmprestados.remove(livro);
    }
}

//CLASSE EMPRESTIMO
package exercicio007;

import java.time.LocalDate;
import java.time.temporal.ChronoUnit;

public class Emprestimo {
    
    private Livro livro;
    private Usuario usuario;
    private LocalDate dataEmprestimo;
    private LocalDate dataDevolucao;

    public Emprestimo(Livro livro, Usuario usuario, LocalDate dataEmprestimo) {
        this.livro = livro;
        this.usuario = usuario;
        this.dataEmprestimo = dataEmprestimo;
        this.dataDevolucao = null;
    }

    public Livro getLivro() {
        return livro;
    }

    public Usuario getUsuario() {
        return usuario;
    }

    public LocalDate getDataEmprestimo() {
        return dataEmprestimo;
    }

    public LocalDate getDataDevolucao() {
        return dataDevolucao;
    }

    public void devolver(LocalDate dataDevolucao) {
        this.dataDevolucao = dataDevolucao;
        livro.setDisponivel(true);
        usuario.devolverLivro(livro);
    }

    public double calcularMulta() {
        if (dataDevolucao == null) {
            return 0;
        }

        long diasAtraso = ChronoUnit.DAYS.between(dataEmprestimo.plusDays(7), dataDevolucao);
        if (diasAtraso > 0) {
            return diasAtraso * 2.0; // Multa de 2 unidades monetárias por dia
        } else {
            return 0;
        }
    }
}

//CLASSE BIBLIOTECA
package exercicio007;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;

public class Biblioteca {
    
    private List<Livro> livros;
    private List<Usuario> usuarios;
    private List<Emprestimo> emprestimos;

    public Biblioteca() {
        livros = new ArrayList<>();
        usuarios = new ArrayList<>();
        emprestimos = new ArrayList<>();
    }

    public void adicionarLivro(Livro livro) {
        livros.add(livro);
    }

    public void adicionarUsuario(Usuario usuario) {
        usuarios.add(usuario);
    }

    public boolean emprestarLivro(Livro livro, Usuario usuario) {
        if (livro.isDisponivel()) {
            livro.setDisponivel(false);
            livro.incrementarEmprestimo();
            usuario.emprestarLivro(livro);
            emprestimos.add(new Emprestimo(livro, usuario, java.time.LocalDate.now()));
            return true;
        }
        return false;
    }

    public void devolverLivro(Livro livro, Usuario usuario) {
        for (Emprestimo e : emprestimos) {
            if (e.getLivro() == livro && e.getUsuario() == usuario && e.getDataDevolucao() == null) {
                e.devolver(java.time.LocalDate.now());
                System.out.println("Multa: " + e.calcularMulta());
                break;
            }
        }
    }

    public void listarLivrosMaisPopulares() {
        livros.sort(Comparator.comparing(Livro::getVezesEmprestado).reversed());
        System.out.println("Livros mais populares:");
        for (Livro livro : livros) {
            System.out.println(livro.getTitulo() + " - Emprestado " + livro.getVezesEmprestado() + " vezes");
        }
    }
}
